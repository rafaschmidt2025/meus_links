name: Atualizar meus_links.json a partir de Issue

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write   # para commit/push
  issues: write     # para comentar/fechar o issue

jobs:
  atualizar-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repositório
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Extrair JSON do Issue e salvar em meus_links.json
        run: |
          node - << 'EOF'
          const fs = require("fs");
          const path = require("path");

          const eventPath = process.env.GITHUB_EVENT_PATH;
          if (!eventPath) {
            throw new Error("GITHUB_EVENT_PATH não definido.");
          }

          const event = JSON.parse(fs.readFileSync(eventPath, "utf8"));

          const body =
            (event.issue && event.issue.body) ||
            (event.pull_request && event.pull_request.body) ||
            "";

          if (!body) {
            throw new Error("Corpo do Issue/PR vazio.");
          }

          // Procura bloco ```json ... ```
          const regex = /```json\s*([\s\S]*?)```/i;
          const match = body.match(regex);

          if (!match) {
            console.log("=== CORPO DO ISSUE LIDO ===");
            console.log(body);
            console.log("=== FIM DO CORPO ===");
            throw new Error(
              "Bloco ```json ... ``` não encontrado no Issue. " +
              "Use o formato:\n```json\n{ ... }\n```"
            );
          }

          const jsonText = match[1].trim();
          let data;

          try {
            data = JSON.parse(jsonText);
          } catch (err) {
            console.error("JSON encontrado, mas inválido:");
            console.error(jsonText);
            throw new Error("Erro ao fazer parse do JSON: " + err.message);
          }

          // Garante que existe __versao (se não vier no Issue)
          if (typeof data === "object" && data !== null) {
            if (!Object.prototype.hasOwnProperty.call(data, "__versao")) {
              data.__versao = 1;
            }
          }

          const outPath = path.join(process.cwd(), "meus_links.json");
          fs.writeFileSync(outPath, JSON.stringify(data, null, 2), "utf8");

          console.log("meus_links.json atualizado com sucesso em:", outPath);
          EOF

      - name: Verificar se houve alterações
        id: diffcheck
        run: |
          if git diff --quiet -- meus_links.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit e push do JSON (se mudou)
        if: steps.diffcheck.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add meus_links.json
          git commit -m "Atualiza meus_links.json a partir do Issue #${{ github.event.issue.number }}"
          git push origin HEAD:main

      - name: Comentar e fechar o Issue
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue.number;
            const repo = context.repo;

            await github.rest.issues.createComment({
              ...repo,
              issue_number,
              body: "✅ JSON processado e salvo em `meus_links.json` pelo GitHub Actions."
            });

            await github.rest.issues.update({
              ...repo,
              issue_number,
              state: "closed"
            });
