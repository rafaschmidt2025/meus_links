<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Meus Links</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">

<!-- =================== PARTE DO CSS =================== -->
<style>
* {
  box-sizing: border-box;
  font-family: Arial, Helvetica, sans-serif;
}

body {
  margin:0;
  background:#f4f7fb;
}

/* Modo leitura (sem admin) */
body.modo-view-only .engrenagem,
body.modo-view-only .category-menu-btn,
body.modo-view-only .favorite-btn,
body.modo-view-only .link-menu-btn {
  display:none !important;
}

header {
  background:#2563eb;
  color:#fff;
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header h1 {
  font-size:20px;
  margin:0;
}

.engrenagem {
  font-size:24px;
  cursor:pointer;
}

.engrenagem:hover {
  transform: rotate(45deg);
  transition:.3s;
}

.container {
  padding:20px;
}

/* Busca */
#searchInput {
  width:100%;
  max-width:400px;
  padding:8px 10px;
  margin:0 0 14px 0;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:13px;
}

/* Layout das categorias */
.grid {
  display:flex;
  flex-wrap:wrap;
  gap:16px;
  align-items:flex-start;
}

.category {
  background:white;
  padding:10px 15px 15px 15px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
  flex:1 1 280px;
  max-width:100%;
  align-self:flex-start;
}

/* Cabe√ßalho da categoria (t√≠tulo + seta + menu) */
.category-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
}

.category-title {
  color:#2563eb;
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
}

.category-right {
  display:flex;
  align-items:center;
  gap:6px;
}

.category-arrow {
  font-size:16px;
  color:#6b7280;
  cursor:pointer;
}

/* Bot√£o menu categoria (3 pontinhos) */
.category-menu-btn {
  font-size:16px;
  color:#6b7280;
  cursor:pointer;
}

/* Corpo da categoria */
.category-body {
  border-top:1px solid #e5e7eb;
  margin-top:6px;
  padding-top:6px;
}

/* Card de link */
.link-card {
  position:relative;
  display:flex;
  gap:10px;
  align-items:flex-start;
  padding:10px;
  margin:10px 0;
  background:#f9fafb;
  border-radius:10px;
  border:1px solid #e5e7eb;
  cursor:pointer;
  transition:0.2s;
}

.link-card:hover {
  background:#eff6ff;
  transform: translateY(-2px);
}

.link-card img {
  width:32px;
  height:32px;
}

.link-content strong {
  font-size:14px;
}

.link-content p {
  margin:4px 0 0 0;
  font-size:12px;
  color:#6b7280;
}

/* Bot√£o dos 3 pontinhos (link) */
.link-menu-btn {
  position:absolute;
  top:6px;
  right:8px;
  font-size:16px;
  cursor:pointer;
  opacity:0;
  transition:0.2s;
}

/* Bot√£o de favorito (estrela) */
.favorite-btn {
  position:absolute;
  top:6px;
  right:26px;
  font-size:16px;
  cursor:pointer;
  color:#d1d5db;
}

.favorite-btn.favorito {
  color:#f59e0b;
}

/* Mostra pontinhos no hover em desktop */
.link-card:hover .link-menu-btn {
  opacity:1;
}

/* Painel admin */
#adminPanel {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:900;
}

.admin-box {
  background:#ffffff;
  padding:20px;
  width:90%;
  max-width:500px;
  border-radius:16px;
}

.admin-box h2 {
  margin-top:0;
  color:#2563eb;
}

input, select, textarea {
  width:100%;
  padding:10px;
  margin-top:8px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #d1d5db;
}

button {
  padding:10px 16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}

/* linha com Salvar / Fechar lado a lado */
.action-buttons {
  display:flex;
  gap:8px;
  margin-top:4px;
  margin-bottom:10px;
}

.action-buttons .add,
.action-buttons .close {
  flex:1;
}

.add {
  background:#2563eb;
  color:#fff;
}

.close {
  background:#e5e7eb;
}

/* Bot√µezinhos de backup */
.small-btn {
  padding:8px 12px;
  font-size:12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  font-weight:bold;
  margin-right:6px;
  margin-top:4px;
}

.btn-export {
  background:#0f766e;
  color:#fff;
}

.btn-import {
  background:#6d28d9;
  color:#fff;
}

.btn-copy {
  background:#4b5563;
  color:#fff;
}

.btn-cloud {
  background:#0369a1;
  color:#fff;
}

/* Menu de contexto (editar/apagar) */
.context-menu {
  position:fixed;
  background:#ffffff;
  border:1px solid #e5e7eb;
  border-radius:8px;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
  padding:6px 0;
  display:none;
  z-index:1000;
}

.context-menu button {
  width:100%;
  text-align:left;
  padding:8px 14px;
  background:none;
  border:none;
  font-size:13px;
  color:#111827;
}

.context-menu button:hover {
  background:#eff6ff;
}

/* Toast de feedback */
#toast {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#111827;
  color:#f9fafb;
  padding:10px 16px;
  border-radius:999px;
  font-size:13px;
  box-shadow:0 6px 16px rgba(0,0,0,0.25);
  display:none;
  z-index:1100;
}

/* Mobile: mostrar sempre o menu ‚ãÆ dos links */
@media (max-width: 600px) {
  .link-menu-btn {
    opacity:1;
  }
}
</style>
</head>
<body>

<header>
  <h1>üîó Meus Links</h1>
  <div class="engrenagem" onclick="abrirAdmin()">‚öôÔ∏è</div>
</header>

<div class="container">
  <!-- Busca -->
  <input id="searchInput" placeholder="Buscar link..." oninput="filtrar()" />

  <!-- Categorias -->
  <div class="grid" id="linkContainer"></div>
</div>

<!-- PAINEL ADMIN -->
<div id="adminPanel">
  <div class="admin-box">
    <h2 id="adminTitle">Adicionar Link</h2>

    <label>Categoria</label>
    <input type="text" id="catInput" list="catList" placeholder="Ex: Trabalho, IA, Estudos">
    <datalist id="catList"></datalist>

    <label>Nome do link</label>
    <input type="text" id="nameInput" placeholder="Ex: ChatGPT">

    <label>URL</label>
    <input type="url" id="urlInput" placeholder="https://...">

    <label>Descri√ß√£o</label>
    <textarea id="descInput" placeholder="Para que √© esse link?"></textarea>

    <div class="action-buttons">
      <button class="add" onclick="salvar()">Salvar link</button>
      <button class="close" onclick="fecharAdmin()">Fechar</button>
    </div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #e5e7eb;">

    <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">
      Backup / sincroniza√ß√£o manual:
    </div>

    <button class="small-btn btn-export" type="button" onclick="exportarJSON()">
      ‚¨áÔ∏è Exportar (.json)
    </button>

    <label for="importFile" class="small-btn btn-import">‚¨ÜÔ∏è Importar (.json)</label>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importarJSON(event)">

    <button class="small-btn btn-copy" type="button" onclick="copiarJSON()">
      üìã Copiar JSON
    </button>

    <button class="small-btn btn-cloud" type="button" onclick="forcarSincronizacao()">
      Baixar do Git
    </button>

    <button id="btnInstallPWA" class="small-btn" type="button"
            style="display:none; background:#4b5563; color:#fff;"
            onclick="instalarPWA()">
      Adicionar √† tela inicial
    </button>

    <!-- Rodap√© com info de cache/sincroniza√ß√£o -->
    <div id="syncInfo" style="margin-top:10px; font-size:11px; color:#6b7280;"></div>
  </div>
</div>

<!-- MENU DE CONTEXTO DOS LINKS -->
<div id="contextMenu" class="context-menu" data-categoria="" data-index="">
  <button onclick="editarLink()">‚úèÔ∏è Editar</button>
  <button onclick="apagarLink()">üóëÔ∏è Apagar</button>
</div>

<!-- MENU DE CONTEXTO DAS CATEGORIAS -->
<div id="categoryMenu" class="context-menu" data-categoria="">
  <button onclick="adicionarLinkCategoria()">‚ûï Adicionar link</button>
  <button onclick="renomearCategoria()">‚úèÔ∏è Renomear categoria</button>
  <button onclick="excluirCategoria()">üóëÔ∏è Excluir categoria</button>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// =================== PARTE DO JS ===================
// ===================================================
// ===== PARTE DE CONFIG / JSON REMOTO / GITHUB ======
// ===================================================
// ===== CONFIGURA√á√ÉO DO JSON REMOTO (PULL) =====
const ONEDRIVE_JSON_URL = "https://raw.githubusercontent.com/rafaschmidt2025/meus_links/main/meus_links.json";

// chave onde a vers√£o fica armazenada dentro do JSON
const JSON_VERSION_KEY = "__versao";

// ===== CACHE DE FAVICONS =====
let faviconCache = {};
try {
  faviconCache = JSON.parse(localStorage.getItem("meusLinksFavicons") || "{}");
} catch(e) {
  faviconCache = {};
}
const FAVICON_CACHE_DIAS = 30;

// ===== INFO DE SINCRONIZA√á√ÉO REMOTA =====
let remoteLastSync   = Number(localStorage.getItem("meusLinksRemoteLastSync")   || "0");
let remoteLastVersao = Number(localStorage.getItem("meusLinksRemoteLastVersao") || "0");

// carrega dados salvos localmente
let dados = JSON.parse(localStorage.getItem("meusLinks")) || {};
let dadosVersao = Number(localStorage.getItem("meusLinksVersao") || "0");

let editInfo = null; // {categoria, index}
let lastCategory = localStorage.getItem("meusLinksUltimaCategoria") || "";
let collapsedCategories = new Set(
  JSON.parse(localStorage.getItem("meusLinksCategoriasFechadas") || "[]")
);

// Modo leitura como padr√£o (sempre inicia desativado)
let isAdmin = false;
localStorage.setItem("meusLinksIsAdmin", "false");

// ===== PWA: beforeinstallprompt + bot√£o "Adicionar √† tela inicial" =====
let deferredPrompt = null;

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById("btnInstallPWA");
  if (btn) btn.style.display = "inline-block";
});

async function instalarPWA() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  if (result.outcome === "accepted") {
    showToast("App adicionado √† tela inicial.");
  }
  deferredPrompt = null;
  const btn = document.getElementById("btnInstallPWA");
  if (btn) btn.style.display = "none";
}

// Se n√£o tiver dados, tenta carregar do remoto (primeira vez apenas)
if (!dados || Object.keys(dados).length === 0) {
  carregarDeOneDrive(true); // auto, sem comparar vers√£o (primeira carga)
}

// aplicar modo admin/leitura
function aplicarModoAdmin(){
  if (isAdmin) {
    document.body.classList.remove("modo-view-only");
    showToast("Modo administrador ativado (Ctrl+Shift+A).");
  } else {
    document.body.classList.add("modo-view-only");
    showToast("Modo leitura ativado (Ctrl+Shift+A).");
  }
}

// atalho Ctrl+Shift+A para alternar modo
document.addEventListener("keydown", function(e){
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "a") {
    e.preventDefault();
    isAdmin = !isAdmin;
    localStorage.setItem("meusLinksIsAdmin", JSON.stringify(isAdmin));
    aplicarModoAdmin();
  }
});

// abrir/fechar painel
function abrirAdmin(){
  if (!isAdmin) return; // seguran√ßa extra
  document.getElementById("adminPanel").style.display="flex";

  setTimeout(() => {
    if (editInfo) {
      document.getElementById("nameInput").focus();
      document.getElementById("nameInput").select();
    } else {
      const catInput = document.getElementById("catInput");
      catInput.value = lastCategory || "";
      catInput.focus();
      catInput.select();
    }
  }, 50);
}

function fecharAdmin(){
  document.getElementById("adminPanel").style.display="none";
  editInfo = null;
  document.getElementById("adminTitle").textContent = "Adicionar Link";
}

// toast
function showToast(msg){
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.style.display = "block";
  setTimeout(() => {
    toast.style.display = "none";
  }, 2500);
}

// helpers de data / contagem
function contarLinksTotais(){
  let total = 0;
  for (const cat in dados) {
    total += dados[cat].length;
  }
  return total;
}

function formatarData(timestamp){
  if (!timestamp) return "Nunca";
  const d = new Date(timestamp);
  return d.toLocaleString("pt-BR");
}

// atualiza texto do rodap√© de info de sincroniza√ß√£o
function atualizarInfoSincronizacao(){
  const el = document.getElementById("syncInfo");
  if (!el) return;

  const totalLinks = contarLinksTotais();
  const localVersao  = dadosVersao || 0;
  const remoteVersao = remoteLastVersao || 0;

  let texto = `Links locais: ${totalLinks} ¬∑ Vers√£o local: ${localVersao}`;

  if (remoteVersao) {
    texto += ` ¬∑ Vers√£o remota conhecida: ${remoteVersao}`;
  }

  if (remoteLastSync) {
    texto += ` ¬∑ √öltima sync: ${formatarData(remoteLastSync)}`;
  }

  el.textContent = texto;
}

// ===== FUN√á√ïES DE BACKUP LOCAL / EXPORT / IMPORT =====

function exportarJSON(){
  const dataStr = JSON.stringify(dados, null, 2);
  const blob = new Blob([dataStr], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "meus_links.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast("Arquivo exportado.");
}

function importarJSON(event){
  const file = event.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(e){
    try {
      const json = JSON.parse(e.target.result);
      if(typeof json === "object" && json !== null){
        dados = json;
        localStorage.setItem("meusLinks", JSON.stringify(dados));

        // se o JSON tiver campo de vers√£o, usamos
        if (JSON_VERSION_KEY in json) {
          dadosVersao = Number(json[JSON_VERSION_KEY]) || 0;
        } else {
          dadosVersao = 0;
        }
        localStorage.setItem("meusLinksVersao", String(dadosVersao));

        collapsedCategories = new Set();
        localStorage.removeItem("meusLinksCategoriasFechadas");
        lastCategory = "";
        localStorage.removeItem("meusLinksUltimaCategoria");
        renderizar();
        atualizarListaCategorias();
        atualizarInfoSincronizacao();
        showToast("Links importados com sucesso.");
      } else {
        alert("Arquivo JSON inv√°lido.");
      }
    } catch(err){
      alert("Erro ao ler o arquivo. Verifique se √© um JSON v√°lido.");
    }
  };
  reader.readAsText(file);
  event.target.value = "";
}

function copiarJSON(){
  const data = JSON.stringify(dados, null, 2);
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(data)
      .then(() => showToast("JSON copiado para a √°rea de transfer√™ncia."))
      .catch(() => alert("N√£o foi poss√≠vel copiar automaticamente. Cole manualmente."));
  } else {
    alert("Seu navegador n√£o permite c√≥pia autom√°tica. Copie manualmente do console.");
  }
}

// bot√£o do painel admin (pull)
function forcarSincronizacao(){
  carregarDeOneDrive(false, true); // manual, s√≥ se vers√£o remota for mais recente
}

// tenta carregar JSON diretamente do servidor (GitHub raw)
// auto = true ‚Üí chamado na inicializa√ß√£o
// apenasSeMaisRecente = true ‚Üí s√≥ substitui se a vers√£o remota for maior
async function carregarDeOneDrive(auto = false, apenasSeMaisRecente = false){
  if (!ONEDRIVE_JSON_URL) {
    if (!auto) {
      alert("Configure o ONEDRIVE_JSON_URL no c√≥digo com o link p√∫blico do JSON.");
    }
    return;
  }

  // cache inteligente: evita chamadas em sequ√™ncia muito r√°pidas
  if (!auto) {
    const now = Date.now();
    const lastCheck = Number(localStorage.getItem("meusLinksRemoteLastCheck") || "0");
    const intervaloMs = 5000; // 5s
    if (now - lastCheck < intervaloMs) {
      showToast("Voc√™ acabou de sincronizar. Aguarde alguns segundos antes de tentar novamente.");
      return;
    }
    localStorage.setItem("meusLinksRemoteLastCheck", String(now));
  }

  try {
    const urlComBypass =
      ONEDRIVE_JSON_URL + (ONEDRIVE_JSON_URL.includes("?") ? "&" : "?") +
      "_t=" + Date.now();

    const resp = await fetch(urlComBypass);
    if (!resp.ok) throw new Error("HTTP " + resp.status);
    const jsonRemoto = await resp.json();

    if (typeof jsonRemoto !== "object" || jsonRemoto === null) {
      throw new Error("JSON remoto inv√°lido");
    }

    let versaoRemota = 0;
    if (JSON_VERSION_KEY in jsonRemoto) {
      versaoRemota = Number(jsonRemoto[JSON_VERSION_KEY]) || 0;
    }

    if (apenasSeMaisRecente && versaoRemota && versaoRemota <= dadosVersao) {
      showToast(
        "Vers√£o remota (" + versaoRemota + ") n√£o √© mais recente que a local (" +
        dadosVersao + "). Nada foi alterado."
      );
      return;
    }

    dados = jsonRemoto;
    localStorage.setItem("meusLinks", JSON.stringify(dados));

    dadosVersao = versaoRemota || 0;
    localStorage.setItem("meusLinksVersao", String(dadosVersao));

    collapsedCategories = new Set();
    localStorage.removeItem("meusLinksCategoriasFechadas");
    lastCategory = "";
    localStorage.removeItem("meusLinksUltimaCategoria");

    remoteLastSync = Date.now();
    remoteLastVersao = versaoRemota || 0;
    localStorage.setItem("meusLinksRemoteLastSync", String(remoteLastSync));
    localStorage.setItem("meusLinksRemoteLastVersao", String(remoteLastVersao));

    renderizar();
    atualizarListaCategorias();
    atualizarInfoSincronizacao();
    showToast("Links carregados do Git com sucesso.");
  } catch (err){
    if (!auto) {
      alert("Erro ao carregar do Git: " + err.message);
    }
  }
}

// ===== RESTO DAS FUN√á√ïES (renderizar, editar, etc.) =====

// salva link
function salvar(){
  const categoriaDigitada = document.getElementById("catInput").value.trim();
  const nome = document.getElementById("nameInput").value.trim();
  const url = document.getElementById("urlInput").value.trim();
  const desc = document.getElementById("descInput").value.trim();

  if(!categoriaDigitada || !nome || !url){
    alert("Preencha categoria, nome e URL.");
    return;
  }

  let categoriaChave = categoriaDigitada;
  for (const cat in dados) {
    if (cat.toLowerCase() === categoriaDigitada.toLowerCase()) {
      categoriaChave = cat;
      break;
    }
  }

  let msgToast = "Link salvo com sucesso.";

  if (editInfo) {
    const oldCat = editInfo.categoria;
    const oldIndex = editInfo.index;
    const oldLink = dados[oldCat][oldIndex];
    const favorito = oldLink.favorito === true;

    if (oldCat.toLowerCase() === categoriaChave.toLowerCase()) {
      dados[categoriaChave][oldIndex] = {nome, url, desc, favorito};
    } else {
      dados[oldCat].splice(oldIndex,1);
      if (dados[oldCat].length === 0) {
        delete dados[oldCat];
      }
      if (!dados[categoriaChave]) {
        dados[categoriaChave] = [];
      }
      dados[categoriaChave].push({nome, url, desc, favorito});
    }
    msgToast = "Link atualizado com sucesso.";
  } else {
    if(!dados[categoriaChave]) {
      dados[categoriaChave] = [];
    }
    dados[categoriaChave].push({nome, url, desc, favorito:false});
  }

  // incrementa "vers√£o local" sempre que altera algo
  dadosVersao = (dadosVersao || 0) + 1;
  dados[JSON_VERSION_KEY] = dadosVersao;
  localStorage.setItem("meusLinksVersao", String(dadosVersao));

  localStorage.setItem("meusLinks", JSON.stringify(dados));
  lastCategory = categoriaChave;
  localStorage.setItem("meusLinksUltimaCategoria", lastCategory);

  document.getElementById("catInput").value="";
  document.getElementById("nameInput").value="";
  document.getElementById("urlInput").value="";
  document.getElementById("descInput").value="";

  fecharAdmin();
  renderizar();
  atualizarListaCategorias();
  atualizarInfoSincronizacao();
  showToast(msgToast);
}

// abre link
function abrirLink(url){
  window.open(url, '_blank');
}

// alternar favorito
function toggleFavorito(event, categoria, index){
  event.stopPropagation();
  const link = dados[categoria][index];
  link.favorito = !link.favorito;
  localStorage.setItem("meusLinks", JSON.stringify(dados));
  renderizar();
}

// MENU DE LINK
function abrirMenu(event, categoria, index){
  event.stopPropagation();
  fecharMenus();
  const menu = document.getElementById("contextMenu");
  menu.style.display = "block";
  menu.style.left = event.clientX + "px";
  menu.style.top = event.clientY + "px";
  menu.dataset.categoria = categoria;
  menu.dataset.index = index;
}

// MENU DE CATEGORIA
function abrirMenuCategoria(event, categoria){
  event.stopPropagation();
  fecharMenus();
  const menu = document.getElementById("categoryMenu");
  menu.style.display = "block";
  menu.style.left = event.clientX + "px";
  menu.style.top = event.clientY + "px";
  menu.dataset.categoria = categoria;
}

function fecharMenus(){
  document.getElementById("contextMenu").style.display = "none";
  document.getElementById("categoryMenu").style.display = "none";
}

// editar/apagar link
function editarLink(){
  const menu = document.getElementById("contextMenu");
  const cat = menu.dataset.categoria;
  const idx = parseInt(menu.dataset.index,10);
  const link = dados[cat][idx];

  document.getElementById("catInput").value = cat;
  document.getElementById("nameInput").value = link.nome;
  document.getElementById("urlInput").value = link.url;
  document.getElementById("descInput").value = link.desc || "";

  editInfo = {categoria: cat, index: idx};
  document.getElementById("adminTitle").textContent = "Editar Link";

  fecharMenus();
  abrirAdmin();
}

function apagarLink(){
  const menu = document.getElementById("contextMenu");
  const cat = menu.dataset.categoria;
  const idx = parseInt(menu.dataset.index,10);

  if(confirm("Deseja realmente apagar este link?")){
    dados[cat].splice(idx,1);
    if (dados[cat].length === 0) {
      delete dados[cat];
    }
    dadosVersao = (dadosVersao || 0) + 1;
    dados[JSON_VERSION_KEY] = dadosVersao;
    localStorage.setItem("meusLinksVersao", String(dadosVersao));

    localStorage.setItem("meusLinks", JSON.stringify(dados));
    renderizar();
    atualizarListaCategorias();
    atualizarInfoSincronizacao();
    showToast("Link apagado.");
  }
  fecharMenus();
}

// a√ß√£o do menu de categoria: adicionar link nessa categoria
function adicionarLinkCategoria(){
  const menu = document.getElementById("categoryMenu");
  const categoria = menu.dataset.categoria;

  fecharMenus();
  editInfo = null;
  document.getElementById("adminTitle").textContent = "Adicionar Link";
  document.getElementById("catInput").value = categoria;
  lastCategory = categoria;
  localStorage.setItem("meusLinksUltimaCategoria", lastCategory);

  document.getElementById("nameInput").value = "";
  document.getElementById("urlInput").value = "";
  document.getElementById("descInput").value = "";

  document.getElementById("adminPanel").style.display = "flex";

  setTimeout(() => {
    document.getElementById("nameInput").focus();
  }, 50);
}

// renomear categoria
function renomearCategoria(){
  const menu = document.getElementById("categoryMenu");
  const categoriaAntiga = menu.dataset.categoria;

  const novaCategoria = prompt(
    "Digite o novo nome para a categoria:",
    categoriaAntiga
  );

  if (!novaCategoria || novaCategoria.trim() === categoriaAntiga) {
    fecharMenus();
    return;
  }

  const novoNome = novaCategoria.trim();
  if (dados[novoNome] && novoNome !== categoriaAntiga) {
    alert("J√° existe uma categoria com esse nome.");
    fecharMenus();
    return;
  }

  dados[novoNome] = dados[categoriaAntiga];
  delete dados[categoriaAntiga];

  if (lastCategory === categoriaAntiga) {
    lastCategory = novoNome;
    localStorage.setItem("meusLinksUltimaCategoria", lastCategory);
  }

  if (collapsedCategories.has(categoriaAntiga)) {
    collapsedCategories.delete(categoriaAntiga);
    collapsedCategories.add(novoNome);
    localStorage.setItem(
      "meusLinksCategoriasFechadas",
      JSON.stringify(Array.from(collapsedCategories))
    );
  }

  dadosVersao = (dadosVersao || 0) + 1;
  dados[JSON_VERSION_KEY] = dadosVersao;
  localStorage.setItem("meusLinksVersao", String(dadosVersao));

  localStorage.setItem("meusLinks", JSON.stringify(dados));

  fecharMenus();
  renderizar();
  atualizarListaCategorias();
  atualizarInfoSincronizacao();
  showToast("Categoria renomeada.");
}

// a√ß√£o do menu de categoria: excluir categoria inteira
function excluirCategoria(){
  const menu = document.getElementById("categoryMenu");
  const categoria = menu.dataset.categoria;

  if (!categoria) {
    fecharMenus();
    return;
  }

  const confirma = confirm(
    `Deseja realmente excluir a categoria "${categoria}" e TODOS os links dela?`
  );

  if (!confirma) {
    fecharMenus();
    return;
  }

  delete dados[categoria];
  dadosVersao = (dadosVersao || 0) + 1;
  dados[JSON_VERSION_KEY] = dadosVersao;
  localStorage.setItem("meusLinksVersao", String(dadosVersao));

  localStorage.setItem("meusLinks", JSON.stringify(dados));

  if (lastCategory === categoria) {
    lastCategory = "";
    localStorage.removeItem("meusLinksUltimaCategoria");
  }

  if (collapsedCategories.has(categoria)) {
    collapsedCategories.delete(categoria);
    localStorage.setItem(
      "meusLinksCategoriasFechadas",
      JSON.stringify(Array.from(collapsedCategories))
    );
  }

  fecharMenus();
  renderizar();
  atualizarListaCategorias();
  atualizarInfoSincronizacao();
  showToast("Categoria exclu√≠da.");
}

// colapsar/expandir categoria
function toggleCategoria(categoria){
  if (collapsedCategories.has(categoria)) {
    collapsedCategories.delete(categoria);
  } else {
    collapsedCategories.add(categoria);
  }
  localStorage.setItem(
    "meusLinksCategoriasFechadas",
    JSON.stringify(Array.from(collapsedCategories))
  );
  renderizar();
}

// busca geral
function filtrar(){
  const termo = document.getElementById("searchInput").value.toLowerCase();
  const container = document.getElementById("linkContainer");
  const cards = container.querySelectorAll(".link-card");
  const categorias = container.querySelectorAll(".category");

  // filtra cards
  cards.forEach(card => {
    const texto = card.innerText.toLowerCase();
    card.style.display = texto.includes(termo) ? "flex" : "none";
  });

  // se a categoria n√£o tiver nenhum card vis√≠vel e o nome n√£o bater, "apaga" visualmente
  categorias.forEach(catEl => {
    const titleEl = catEl.querySelector(".category-title");
    const catName = titleEl ? titleEl.textContent.toLowerCase() : "";
    const visibleCards = catEl.querySelectorAll(".link-card[style*='display: flex']");
    if (termo && !catName.includes(termo) && visibleCards.length === 0) {
      catEl.style.opacity = "0.25";
    } else {
      catEl.style.opacity = "1";
    }
  });
}

// renderizar categorias e links
function renderizar(){
  const container = document.getElementById("linkContainer");
  container.innerHTML = "";

  const categorias = Object.keys(dados).sort((a,b) => a.localeCompare(b, "pt-BR"));

  categorias.forEach(categoria => {
    const col = document.createElement("div");
    col.className = "category";

    const collapsed = collapsedCategories.has(categoria);
    const arrow = collapsed ? "‚ñ∏" : "‚ñæ";

    const linksOrdenados = [...dados[categoria]].map((l,idx) => ({...l, _idx:idx}));
    linksOrdenados.sort((a,b) => {
      if ((a.favorito===true) !== (b.favorito===true)) {
        return a.favorito ? -1 : 1;
      }
      return a.nome.localeCompare(b.nome,"pt-BR");
    });

    let html = `
      <div class="category-header">
        <span class="category-title" onclick="toggleCategoria('${categoria.replace(/'/g,"\\'")}')">${categoria}</span>
        <div class="category-right">
          <span class="category-menu-btn" onclick="abrirMenuCategoria(event, '${categoria.replace(/'/g,"\\'")}')">&#8942;</span>
          <span class="category-arrow" onclick="toggleCategoria('${categoria.replace(/'/g,"\\'")}')">${arrow}</span>
        </div>
      </div>
      <div class="category-body" style="display:${collapsed ? "none" : "block"};">
    `;

    linksOrdenados.forEach(link => {
      const indexOriginal = link._idx;
      const faviconKey = new URL(link.url).origin;
      let favicon = faviconCache[faviconKey];

      if (!favicon) {
        favicon = `https://www.google.com/s2/favicons?domain=${encodeURIComponent(link.url)}`;
        faviconCache[faviconKey] = favicon;
        localStorage.setItem("meusLinksFavicons", JSON.stringify(faviconCache));
      }

      const favClass = link.favorito ? "favorite-btn favorito" : "favorite-btn";

      html += `
      <div class="link-card" onclick="abrirLink('${link.url}')">
        <img src="${favicon}" alt="">
        <div class="link-content">
          <strong>${link.nome}</strong>
          <p>${link.desc || ""}</p>
        </div>
        <span class="${favClass}" onclick="toggleFavorito(event, '${categoria.replace(/'/g,"\\'")}', ${indexOriginal})">‚òÖ</span>
        <span class="link-menu-btn" onclick="abrirMenu(event, '${categoria.replace(/'/g,"\\'")}', ${indexOriginal})">&#8942;</span>
      </div>`;
    });

    html += `</div>`;

    col.innerHTML = html;
    container.appendChild(col);
  });

  if (document.getElementById("searchInput").value.trim() !== "") {
    filtrar();
  }
}

// datalist de categorias
function atualizarListaCategorias(){
  const datalist = document.getElementById("catList");
  if (!datalist) return;

  datalist.innerHTML = "";
  const categorias = Object.keys(dados).sort((a,b) => a.localeCompare(b, "pt-BR"));

  categorias.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    datalist.appendChild(opt);
  });
}

// Enter para salvar
function configurarEnter(){
  ["catInput","nameInput","urlInput","descInput"].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("keydown", function(e){
      if(e.key === "Enter"){
        e.preventDefault();
        salvar();
      }
    });
  });
}

// fechar menus ao clicar fora
document.addEventListener("click", function(e){
  const contextMenu = document.getElementById("contextMenu");
  const catMenu = document.getElementById("categoryMenu");

  if (contextMenu.style.display === "block" && !e.target.closest("#contextMenu")) {
    contextMenu.style.display = "none";
  }
  if (catMenu.style.display === "block" && !e.target.closest("#categoryMenu")) {
    catMenu.style.display = "none";
  }
});

// inicializa√ß√£o
renderizar();
atualizarListaCategorias();
configurarEnter();
aplicarModoAdmin(); // aplica modo leitura/admin ao abrir
atualizarInfoSincronizacao();
</script>

</body>
</html>

