<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Meus Links</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">

<!-- =================== PARTE DO CSS =================== -->
<style>
* {
  box-sizing: border-box;
  font-family: Arial, Helvetica, sans-serif;
}

body {
  margin:0;
  background:#f4f7fb;
}

/* Modo leitura (sem admin) ‚Äì esconde s√≥ bot√µes de edi√ß√£o, N√ÉO a estrela */
body.modo-view-only .engrenagem,
body.modo-view-only .category-menu-btn,
body.modo-view-only .link-menu-btn {
  display:none !important;
}

header {
  background:#2563eb;
  color:#fff;
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header h1 {
  font-size:20px;
  margin:0;
}

.engrenagem {
  font-size:24px;
  cursor:pointer;
}

.engrenagem:hover {
  transform: rotate(45deg);
  transition:.3s;
}

.container {
  padding:20px;
}

/* Busca */
#searchInput {
  width:100%;
  max-width:400px;
  padding:8px 10px;
  margin:0 0 14px 0;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:13px;
}

/* Layout das categorias - CSS Grid */
.grid {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap:16px;
  align-items:flex-start;
}

/* Card da categoria */
.category {
  background:white;
  padding:10px 15px 15px 15px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
  width:100%;
  align-self:flex-start;
}

/* Cabe√ßalho da categoria (t√≠tulo + seta + menu) */
.category-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
}

.category-title {
  color:#2563eb;
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
}

.category-right {
  display:flex;
  align-items:center;
  gap:6px;
}

.category-arrow {
  font-size:16px;
  color:#6b7280;
  cursor:pointer;
}

/* Bot√£o menu categoria (3 pontinhos) */
.category-menu-btn {
  font-size:16px;
  color:#6b7280;
  cursor:pointer;
}

/* Corpo da categoria (lista de links) */
.category-body {
  border-top:1px solid #e5e7eb;
  margin-top:6px;
  padding-top:6px;

  /* m√°ximo ~5 cards, com scroll se passar disso */
  max-height:320px;
  overflow-y:auto;
}

/* Card de link */
.link-card {
  position:relative;
  display:flex;
  gap:10px;
  align-items:flex-start;
  padding:10px;
  margin:10px 0;
  background:#f9fafb;
  border-radius:10px;
  border:1px solid #e5e7eb;
  cursor:pointer;
  transition:0.2s;
}

.link-card:hover {
  background:#eff6ff;
  transform: translateY(-2px);
}

.link-card img {
  width:32px;
  height:32px;
}

.link-content strong {
  font-size:14px;
}

.link-content p {
  margin:4px 0 0 0;
  font-size:12px;
  color:#6b7280;
}

/* Bot√£o dos 3 pontinhos (link) */
.link-menu-btn {
  position:absolute;
  top:6px;
  right:8px;
  font-size:16px;
  cursor:pointer;
  opacity:0;
  transition:0.2s;
}

/* Bot√£o de favorito (estrela) */
.favorite-btn {
  position:absolute;
  top:6px;
  right:26px;
  font-size:16px;
  cursor:pointer;
  color:#d1d5db;
}

.favorite-btn.favorito {
  color:#f59e0b;
}

/* Mostra pontinhos no hover em desktop */
.link-card:hover .link-menu-btn {
  opacity:1;
}

/* Painel admin */
#adminPanel {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:900;
}

.admin-box {
  background:#ffffff;
  padding:20px;
  width:90%;
  max-width:500px;
  border-radius:16px;
}

.admin-box h2 {
  margin-top:0;
  color:#2563eb;
}

input, select, textarea {
  width:100%;
  padding:10px;
  margin-top:8px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #d1d5db;
}

button {
  padding:10px 16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}

/* linha com Salvar / Fechar lado a lado */
.action-buttons {
  display:flex;
  gap:8px;
  margin-top:4px;
  margin-bottom:10px;
}

.action-buttons .add,
.action-buttons .close {
  flex:1;
}

.add {
  background:#2563eb;
  color:#fff;
}

.close {
  background:#e5e7eb;
}

/* Bot√µezinhos de backup */
.small-btn {
  padding:8px 12px;
  font-size:12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  font-weight:bold;
  margin-right:6px;
  margin-top:4px;
}

.btn-export {
  background:#0f766e;
  color:#fff;
}

.btn-import {
  background:#6d28d9;
  color:#fff;
}

.btn-cloud {
  background:#0369a1;
  color:#fff;
}

/* Menu de contexto (editar/apagar) */
.context-menu {
  position:fixed;
  background:#ffffff;
  border:1px solid #e5e7eb;
  border-radius:8px;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
  padding:6px 0;
  display:none;
  z-index:1000;
}

.context-menu button {
  width:100%;
  text-align:left;
  padding:8px 14px;
  background:none;
  border:none;
  font-size:13px;
  color:#111827;
}

.context-menu button:hover {
  background:#eff6ff;
}

/* Toast de feedback */
#toast {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#111827;
  color:#f9fafb;
  padding:10px 16px;
  border-radius:999px;
  font-size:13px;
  box-shadow:0 6px 16px rgba(0,0,0,0.25);
  display:none;
  z-index:1100;
}

/* Mobile: mostrar sempre o menu ‚ãÆ dos links */
@media (max-width: 600px) {
  .link-menu-btn {
    opacity:1;
  }
}
</style>
</head>

<body class="modo-view-only">

<header>
  <h1 id="appTitle" title="Clique 3x para alternar modo administrador" style="cursor:pointer;">üîó Meus Links</h1>
  <div class="engrenagem" onclick="abrirAdmin()">‚öôÔ∏è</div>
</header>

<div class="container">
  <!-- Busca -->
  <input id="searchInput" placeholder="Buscar link..." oninput="filtrar()" />

  <!-- Categorias -->
  <div class="grid" id="linkContainer"></div>
</div>

<!-- PAINEL ADMIN -->
<div id="adminPanel">
  <div class="admin-box">
    <h2 id="adminTitle">Adicionar Link</h2>

    <label>Categoria</label>
    <input type="text" id="catInput" list="catList" placeholder="Ex: Trabalho, IA, Estudos">
    <datalist id="catList"></datalist>

    <label>Nome do link</label>
    <input type="text" id="nameInput" placeholder="Ex: ChatGPT">

    <label>URL</label>
    <input type="url" id="urlInput" placeholder="https://...">

    <label>Descri√ß√£o</label>
    <textarea id="descInput" placeholder="Para que √© esse link?"></textarea>

    <div class="action-buttons">
      <button class="add" onclick="salvar()">Salvar link</button>
      <button class="close" onclick="fecharAdmin()">Fechar</button>
    </div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #e5e7eb;">

    <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">
      Backup manual (arquivo .json):
    </div>

    <button class="small-btn btn-export" type="button" onclick="exportarJSON()">Download JSON</button>

    <label for="importFile" class="small-btn btn-import">Upload JSON</label>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importarJSON(event)">

    <button id="btnInstallPWA" class="small-btn" type="button"
            style="display:none; background:#4b5563; color:#fff;"
            onclick="instalarPWA()">
      Adicionar √† tela inicial
    </button>

    <div id="syncInfo" style="margin-top:10px; font-size:11px; color:#6b7280;"></div>

  </div>
</div>

<!-- MENU DE CONTEXTO DOS LINKS -->
<div id="contextMenu" class="context-menu" data-categoria="" data-index="">
  <button onclick="editarLink()">‚úèÔ∏è Editar</button>
  <button onclick="apagarLink()">üóëÔ∏è Apagar</button>
</div>

<!-- MENU DE CONTEXTO DAS CATEGORIAS -->
<div id="categoryMenu" class="context-menu" data-categoria="">
  <button onclick="adicionarLinkCategoria()">‚ûï Adicionar link</button>
  <button onclick="renomearCategoria()">‚úèÔ∏è Renomear categoria</button>
  <button onclick="excluirCategoria()">üóëÔ∏è Excluir categoria</button>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- =================== PARTE DO JAVASCRIPT / L√ìGICA =================== -->
<script>
// =============================================================
// ============ PARTE DE CONFIG / JSON REMOTO / GITHUB ==========
// =============================================================
// ===== CONFIGURA√á√ÉO DO JSON REMOTO (PULL) =====
const ONEDRIVE_JSON_URL = "https://raw.githubusercontent.com/rafaschmidt2025/meus_links/main/meus_links.json";

// chave onde a vers√£o fica armazenada dentro do JSON
const JSON_VERSION_KEY = "__versao";

// ===== CONFIG GITHUB (PUSH) =====
const GITHUB_OWNER = "rafaschmidt2025";
const GITHUB_REPO  = "meus_links";
const GITHUB_FILE_PATH = "meus_links.json";

// ‚ö†Ô∏è N√ÉO USE TOKEN REAL AQUI EM REPO P√öBLICO
const GITHUB_TOKEN = "rafael";

// ===== CACHE DE FAVICONS =====
let faviconCache = {};
try {
  faviconCache = JSON.parse(localStorage.getItem("meusLinksFavicons") || "{}");
} catch(e) {
  faviconCache = {};
}
const FAVICON_CACHE_DIAS = 30;

// ===== INFO DE SINCRONIZA√á√ÉO REMOTA =====
let remoteLastSync   = Number(localStorage.getItem("meusLinksRemoteLastSync")   || "0");
let remoteLastVersao = Number(localStorage.getItem("meusLinksRemoteLastVersao") || "0");

// carrega dados salvos localmente
let dados = JSON.parse(localStorage.getItem("meusLinks")) || {};
  window.dados = dados;

let dadosVersao = Number(localStorage.getItem("meusLinksVersao") || "0");

let editInfo = null; // {categoria, index}
let lastCategory = localStorage.getItem("meusLinksUltimaCategoria") || "";
let collapsedCategories = new Set(
  JSON.parse(localStorage.getItem("meusLinksCategoriasFechadas") || "[]")
);

// modo admin/leitura respeitando o que estiver salvo
let isAdmin = JSON.parse(localStorage.getItem("meusLinksIsAdmin") || "false");

// ===== PWA: beforeinstallprompt + bot√£o "Adicionar √† tela inicial" =====
let deferredPrompt = null;

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById("btnInstallPWA");
  if (btn) btn.style.display = "inline-block";
});

async function instalarPWA(){
  if (!deferredPrompt){
    alert("Se o navegador suportar, use 'Adicionar √† tela inicial' no menu do navegador.");
    return;
  }
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  if (choice && choice.outcome === "accepted") {
    showToast("Instala√ß√£o iniciada. Verifique a tela inicial do seu dispositivo.");
  }
  deferredPrompt = null;
  const btn = document.getElementById("btnInstallPWA");
  if (btn) btn.style.display = "none";
}

// Service Worker para PWA
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js").catch(() => {});
  });
}

// aplicar modo admin/leitura
function aplicarModoAdmin(){
  if (isAdmin) {
    document.body.classList.remove("modo-view-only");
    showToast("Modo administrador ativado (Ctrl+Shift+A).");
  } else {
    document.body.classList.add("modo-view-only");
    showToast("Modo leitura ativado (Ctrl+Shift+A).");
  }
}

// alternar modo admin (atalho + clique 3x)
function alternarModoAdmin(){
  isAdmin = !isAdmin;
  localStorage.setItem("meusLinksIsAdmin", JSON.stringify(isAdmin));
  aplicarModoAdmin();
}

// l√≥gica de clique triplo no t√≠tulo
let tituloClickCount = 0;
let tituloClickTimer = null;

function handleTituloTripleClick() {
  tituloClickCount++;
  if (tituloClickTimer) clearTimeout(tituloClickTimer);
  tituloClickTimer = setTimeout(() => {
    tituloClickCount = 0;
    tituloClickTimer = null;
  }, 600); // janela de 600ms para contar os 3 cliques

  if (tituloClickCount >= 3) {
    tituloClickCount = 0;
    tituloClickTimer = null;
    alternarModoAdmin();
  }
}

const tituloEl = document.getElementById("appTitle");
if (tituloEl) {
  tituloEl.addEventListener("click", handleTituloTripleClick);
}

// atalho Ctrl+Shift+A para alternar modo
document.addEventListener("keydown", function(e){
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "a") {
    e.preventDefault();
    alternarModoAdmin();
  }
});

// abrir/fechar painel
function abrirAdmin(){
  if (!isAdmin) return; // seguran√ßa: s√≥ admin
  document.getElementById("adminPanel").style.display="flex";

  setTimeout(() => {
    if (editInfo) {
      document.getElementById("nameInput").focus();
      document.getElementById("nameInput").select();
    } else {
      const catInput = document.getElementById("catInput");
      catInput.value = lastCategory || "";
      catInput.focus();
      catInput.select();
    }
  }, 50);
}

function fecharAdmin(){
  document.getElementById("adminPanel").style.display="none";
  editInfo = null;
  document.getElementById("adminTitle").textContent = "Adicionar Link";
}

// toast
function showToast(msg){
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.style.display = "block";
  setTimeout(() => {
    toast.style.display = "none";
  }, 2500);
}

// helpers de data / contagem
function contarLinksTotais(){
  let total = 0;
  for (const cat in dados) {
    if (cat === JSON_VERSION_KEY) continue;
    const arr = dados[cat];
    if (Array.isArray(arr)) total += arr.length;
  }
  return total;
}

function formatarDataHora(timestamp){
  if (!timestamp) return "nunca";
  try {
    return new Date(timestamp).toLocaleString("pt-BR");
  } catch {
    return "nunca";
  }
}

function atualizarInfoSincronizacao(){
  const el = document.getElementById("syncInfo");
  if (!el) return;
  const totalLinks = contarLinksTotais();
  el.textContent =
    "√öltima sincroniza√ß√£o remota: " + formatarDataHora(remoteLastSync) +
    " ‚Ä¢ Vers√£o remota conhecida: " + (remoteLastVersao || "‚Äî") +
    " ‚Ä¢ Links atuais: " + totalLinks;
}

// ===== FAVICONS =====
function carregarFavicons() {
  const imgs = document.querySelectorAll("img.favicon-img");
  imgs.forEach(img => {
    const domain = img.dataset.domain;
    if (!domain) return;

    img.src = "https://www.google.com/s2/favicons?domain=" +
      encodeURIComponent(domain) + "&sz=32";
  });
}
function normalizarUrlParaSalvar(url) {
  let u = (url || "").trim();
  if (!u) return "";

  // se n√£o come√ßar com http ou https, assume https://
  if (!/^https?:\/\//i.test(u)) {
    u = "https://" + u;
  }
  return u;
}

function chaveComparacaoURL(url) {
  try {
    let u = (url || "").trim();
    if (!u) return "";

    if (!/^https?:\/\//i.test(u)) {
      u = "https://" + u;
    }

    const obj = new URL(u);
    let host = obj.hostname.toLowerCase();
    if (host.startsWith("www.")) host = host.slice(4);

    let path = obj.pathname || "/";
    // tira barras finais repetidas
    path = path.replace(/\/+$/,"");
    if (path === "") path = "/";

    return host + path; // exemplo: "itau.com.br/"
  } catch(e) {
    // se der erro, volta pro texto cru, min√∫sculo
    return (url || "").trim().toLowerCase();
  }
}

// salva link
function salvar(){
  const categoriaDigitada = document.getElementById("catInput").value.trim();
  const nome = document.getElementById("nameInput").value.trim();
  const urlDigitada = document.getElementById("urlInput").value.trim();
  const desc = document.getElementById("descInput").value.trim();

  if (!categoriaDigitada || !nome || !urlDigitada) {
    alert("Preencha categoria, nome e URL.");
    return;
  }

  // normaliza categoria (case-insensitive)
  let categoriaChave = categoriaDigitada;
  for (const cat in dados) {
    if (cat.toLowerCase() === categoriaDigitada.toLowerCase()) {
      categoriaChave = cat;
      break;
    }
  }

  const nomeLower = nome.toLowerCase();
  const urlNormalizada = normalizarUrlParaSalvar(urlDigitada);
  const chaveUrlNova = chaveComparacaoURL(urlNormalizada);

  // ========== VERIFICA DUPLICADOS EM TODAS AS CATEGORIAS ==========
  const duplicados = [];

  for (const [cat, linksCat] of Object.entries(dados || {})) {
    if (!Array.isArray(linksCat)) continue; // ignora coisas que n√£o s√£o lista de links

    linksCat.forEach((l, idx) => {
      // se estiver editando este pr√≥prio link, ignora na compara√ß√£o
      if (editInfo &&
          editInfo.categoria === cat &&
          editInfo.index === idx) {
        return;
      }

      const nomeExistente = (l.nome || "").trim().toLowerCase();
      const chaveUrlExistente = chaveComparacaoURL(l.url);

      const nomeIgual = nomeExistente === nomeLower;
      const urlIgual  = chaveUrlExistente === chaveUrlNova;

      if (nomeIgual || urlIgual) {
        let motivo = "";
        if (nomeIgual && urlIgual) motivo = "nome e URL equivalentes";
        else if (nomeIgual)        motivo = "nome equivalente";
        else if (urlIgual)         motivo = "URL equivalente (mesmo site/endere√ßo)";

        duplicados.push({
          categoria: cat,
          link: l,
          motivo
        });
      }
    });
  }

  if (duplicados.length > 0) {
    let msg = "J√° existe(m) link(s) equivalente(s) a este:\n\n";
    duplicados.forEach(d => {
      msg += `- Categoria: ${d.categoria}\n` +
             `  ‚Ä¢ Link: "${d.link.nome}"\n` +
             `  ‚Ä¢ Motivo: ${d.motivo}\n` +
             `  ‚Ä¢ URL: ${d.link.url}\n\n`;
    });
    alert(msg);
    return; // N√ÉO salva
  }
  // ===============================================================

  let msgToast = "Link salvo com sucesso.";

  if (editInfo) {
    const oldCat = editInfo.categoria;
    const oldIndex = editInfo.index;
    const oldLink = dados[oldCat][oldIndex];
    const favorito = oldLink.favorito === true;

    if (oldCat.toLowerCase() === categoriaChave.toLowerCase()) {
      // edi√ß√£o na mesma categoria
      dados[categoriaChave][oldIndex] = {
        nome,
        url: urlNormalizada,
        desc,
        favorito
      };
    } else {
      // mudou de categoria: remove da antiga e joga na nova
      dados[oldCat].splice(oldIndex, 1);
      if (dados[oldCat].length === 0) {
        delete dados[oldCat];
      }
      if (!dados[categoriaChave]) {
        dados[categoriaChave] = [];
      }
      dados[categoriaChave].push({
        nome,
        url: urlNormalizada,
        desc,
        favorito
      });
    }
    msgToast = "Link atualizado com sucesso.";
  } else {
    // novo link
    if (!dados[categoriaChave]) {
      dados[categoriaChave] = [];
    }
    dados[categoriaChave].push({
      nome,
      url: urlNormalizada,
      desc,
      favorito:false
    });
  }

  // garante que Firestore veja a vers√£o atual
  window.dados = dados;
  localStorage.setItem("meusLinks", JSON.stringify(dados));

  lastCategory = categoriaChave;
  localStorage.setItem("meusLinksUltimaCategoria", lastCategory);

  document.getElementById("catInput").value = "";
  document.getElementById("nameInput").value = "";
  document.getElementById("urlInput").value = "";
  document.getElementById("descInput").value = "";

  fecharAdmin();
  renderizar();
  atualizarListaCategorias();
  showToast(msgToast);
}


// abre link
function abrirLink(url){
  window.open(url, '_blank');
}

// alternar favorito
function toggleFavorito(event, categoria, index){
  event.stopPropagation();
  const link = dados[categoria][index];
  link.favorito = !link.favorito;
  localStorage.setItem("meusLinks", JSON.stringify(dados));
  renderizar();
}

// MENU DE LINK
function abrirMenu(event, categoria, index){
  event.stopPropagation();
  fecharMenus();
  const menu = document.getElementById("contextMenu");
  menu.style.display = "block";
  menu.style.left = event.clientX + "px";
  menu.style.top = event.clientY + "px";
  menu.dataset.categoria = categoria;
  menu.dataset.index = index;
}

// MENU DE CATEGORIA
function abrirMenuCategoria(event, categoria){
  event.stopPropagation();
  if (categoria === "‚≠ê Favoritos") {
    // categoria especial n√£o tem menu pr√≥prio
    return;
  }
  fecharMenus();
  const menu = document.getElementById("categoryMenu");
  menu.style.display = "block";
  menu.style.left = event.clientX + "px";
  menu.style.top = event.clientY + "px";
  menu.dataset.categoria = categoria;
}

function fecharMenus(){
  document.getElementById("contextMenu").style.display = "none";
  document.getElementById("categoryMenu").style.display = "none";
}

// editar/apagar link
function editarLink(){
  const menu = document.getElementById("contextMenu");
  const cat = menu.dataset.categoria;
  const idx = parseInt(menu.dataset.index,10);
  const link = dados[cat][idx];

  document.getElementById("catInput").value = cat;
  document.getElementById("nameInput").value = link.nome;
  document.getElementById("urlInput").value = link.url;
  document.getElementById("descInput").value = link.desc || "";

  editInfo = {categoria: cat, index: idx};
  document.getElementById("adminTitle").textContent = "Editar Link";

  fecharMenus();
  abrirAdmin();
}

function apagarLink(){
  const menu = document.getElementById("contextMenu");
  const cat = menu.dataset.categoria;
  const idx = parseInt(menu.dataset.index,10);

  if(confirm("Deseja realmente apagar este link?")){
    dados[cat].splice(idx,1);
    if (dados[cat].length === 0) {
      delete dados[cat];
    }
    localStorage.setItem("meusLinks", JSON.stringify(dados));
    renderizar();
    atualizarListaCategorias();
    showToast("Link apagado.");
  }
  fecharMenus();
}

// a√ß√£o do menu de categoria: adicionar link nessa categoria
function adicionarLinkCategoria(){
  const menu = document.getElementById("categoryMenu");
  const categoria = menu.dataset.categoria;

  fecharMenus();
  editInfo = null;
  document.getElementById("adminTitle").textContent = "Adicionar Link";
  document.getElementById("catInput").value = categoria;
  lastCategory = categoria;
  localStorage.setItem("meusLinksUltimaCategoria", lastCategory);

  document.getElementById("nameInput").value = "";
  document.getElementById("urlInput").value = "";
  document.getElementById("descInput").value = "";

  document.getElementById("adminPanel").style.display = "flex";

  setTimeout(() => {
    document.getElementById("nameInput").focus();
  }, 50);
}

// renomear categoria (com merge se j√° existir)
function renomearCategoria(){
  const menu = document.getElementById("categoryMenu");
  const categoria = menu.dataset.categoria;
  if (!categoria) return;

  const novoNome = prompt("Novo nome para a categoria:", categoria);
  if (!novoNome) {
    fecharMenus();
    return;
  }

  const nomeTrim = novoNome.trim();
  if (!nomeTrim || nomeTrim.toLowerCase() === categoria.toLowerCase()) {
    fecharMenus();
    return;
  }

  let alvo = nomeTrim;
  // se j√° existir categoria com mesmo nome (case-insensitive), usa a chave existente
  for (const cat in dados) {
    if (cat.toLowerCase() === nomeTrim.toLowerCase()) {
      alvo = cat;
      break;
    }
  }

  // merge
  if (!dados[alvo]) {
    dados[alvo] = [];
  }
  dados[alvo] = dados[alvo].concat(dados[categoria] || []);
  delete dados[categoria];

  // ajusta √∫ltimas configs
  if (lastCategory === categoria) {
    lastCategory = alvo;
    localStorage.setItem("meusLinksUltimaCategoria", lastCategory);
  }

  if (collapsedCategories.has(categoria)) {
    collapsedCategories.delete(categoria);
    collapsedCategories.add(alvo);
    localStorage.setItem(
      "meusLinksCategoriasFechadas",
      JSON.stringify(Array.from(collapsedCategories))
    );
  }

  localStorage.setItem("meusLinks", JSON.stringify(dados));
  fecharMenus();
  renderizar();
  atualizarListaCategorias();
  showToast(`Categoria renomeada para "${alvo}".`);
}

// a√ß√£o do menu de categoria: excluir categoria inteira
function excluirCategoria(){
  const menu = document.getElementById("categoryMenu");
  const categoria = menu.dataset.categoria;

  if (!categoria) {
    fecharMenus();
    return;
  }

  const confirma = confirm(
    `Deseja realmente excluir a categoria "${categoria}" e TODOS os links dela?`
  );

  if (!confirma) {
    fecharMenus();
    return;
  }

  delete dados[categoria];
  localStorage.setItem("meusLinks", JSON.stringify(dados));

  if (lastCategory === categoria) {
    lastCategory = "";
    localStorage.removeItem("meusLinksUltimaCategoria");
  }

  if (collapsedCategories.has(categoria)) {
    collapsedCategories.delete(categoria);
    localStorage.setItem(
      "meusLinksCategoriasFechadas",
      JSON.stringify(Array.from(collapsedCategories))
    );
  }

  fecharMenus();
  renderizar();
  atualizarListaCategorias();
  showToast("Categoria exclu√≠da.");
}

// colapsar/expandir categoria
function toggleCategoria(categoria){
  if (collapsedCategories.has(categoria)) {
    collapsedCategories.delete(categoria);
  } else {
    collapsedCategories.add(categoria);
  }
  localStorage.setItem(
    "meusLinksCategoriasFechadas",
    JSON.stringify(Array.from(collapsedCategories))
  );
  renderizar();
}

// busca geral
function filtrar(){
  const termo = document.getElementById("searchInput").value.toLowerCase();
  const container = document.getElementById("linkContainer");
  const cards = container.querySelectorAll(".link-card");
  const categorias = container.querySelectorAll(".category");

  // filtra cards
  cards.forEach(card => {
    const texto = card.innerText.toLowerCase();
    card.style.display = texto.includes(termo) ? "flex" : "none";
  });

  // se a categoria n√£o tiver nenhum card vis√≠vel e o nome n√£o bater, "apaga" visualmente
  categorias.forEach(catEl => {
    const titleEl = catEl.querySelector(".category-title");
    const catName = titleEl ? titleEl.textContent.toLowerCase() : "";
    const visibleCards = catEl.querySelectorAll(".link-card[style*='display: flex']");
    if (termo && !catName.includes(termo) && visibleCards.length === 0) {
      catEl.style.opacity = "0.25";
    } else {
      catEl.style.opacity = "1";
    }
  });
}

// renderizar categorias e links
function renderizar(){
  const container = document.getElementById("linkContainer");
  container.innerHTML = "";

  const categoriasBase = Object.keys(dados)
    .filter(c => c !== JSON_VERSION_KEY)
    .sort((a,b) => a.localeCompare(b, "pt-BR"));

  // monta lista global de favoritos (para categoria especial)
  const favoritosGlobais = [];
  categoriasBase.forEach(categoria => {
    const arr = dados[categoria] || [];
    arr.forEach((link, idx) => {
      if (link.favorito) {
        favoritosGlobais.push({
          categoria,
          index: idx,
          link
        });
      }
    });
  });

  // Categoria especial "‚≠ê Favoritos"
  if (favoritosGlobais.length > 0) {
    const colFav = document.createElement("div");
    colFav.className = "category";

    const collapsedFav = collapsedCategories.has("‚≠ê Favoritos");
    const arrowFav = collapsedFav ? "‚ñ∏" : "‚ñæ";

    let htmlFav = `
      <div class="category-header">
        <span class="category-title" onclick="toggleCategoria('‚≠ê Favoritos')">‚≠ê Favoritos</span>
        <div class="category-right">
          <span class="category-arrow" onclick="toggleCategoria('‚≠ê Favoritos')">${arrowFav}</span>
        </div>
      </div>
      <div class="category-body" style="display:${collapsedFav ? "none" : "block"};">
    `;

    favoritosGlobais.sort((a,b) =>
      a.link.nome.localeCompare(b.link.nome, "pt-BR")
    );

    favoritosGlobais.forEach(item => {
      const dominio = extrairDominio(item.link.url);
      const favClass = item.link.favorito ? "favorite-btn favorito" : "favorite-btn";
      const catLabel = item.categoria;

      htmlFav += `
        <div class="link-card" onclick="abrirLink('${item.link.url}')">
          <img class="favicon-img" data-domain="${dominio}" alt="">
          <div class="link-content">
            <strong>${item.link.nome}</strong>
            <p>${item.link.desc || ""}</p>
            <p style="margin-top:2px; font-size:11px; color:#9ca3af;">Categoria: ${catLabel}</p>
          </div>
          <span class="${favClass}" onclick="toggleFavorito(event, '${item.categoria.replace(/'/g,"\\'")}', ${item.index})">‚òÖ</span>
          <span class="link-menu-btn" onclick="abrirMenu(event, '${item.categoria.replace(/'/g,"\\'")}', ${item.index})">&#8942;</span>
        </div>
      `;
    });

    htmlFav += "</div>";
    colFav.innerHTML = htmlFav;
    container.appendChild(colFav);
  }

  // categorias normais
  categoriasBase.forEach(categoria => {
    const col = document.createElement("div");
    col.className = "category";

    const collapsed = collapsedCategories.has(categoria);
    const arrow = collapsed ? "‚ñ∏" : "‚ñæ";

    const linksOrdenados = [...dados[categoria]].map((l,idx) => ({...l, _idx:idx}));
    linksOrdenados.sort((a,b) => {
      if ((a.favorito===true) !== (b.favorito===true)) {
        return a.favorito ? -1 : 1; // favoritos primeiro
      }
      return a.nome.localeCompare(b.nome,"pt-BR");
    });

    let html = `
      <div class="category-header">
        <span class="category-title" onclick="toggleCategoria('${categoria.replace(/'/g,"\\'")}')">${categoria}</span>
        <div class="category-right">
          <span class="category-menu-btn" onclick="abrirMenuCategoria(event, '${categoria.replace(/'/g,"\\'")}')">&#8942;</span>
          <span class="category-arrow" onclick="toggleCategoria('${categoria.replace(/'/g,"\\'")}')">${arrow}</span>
        </div>
      </div>
      <div class="category-body" style="display:${collapsed ? "none" : "block"};">
    `;

    linksOrdenados.forEach(link => {
      const indexOriginal = link._idx;
      const dominio = extrairDominio(link.url);
      const favClass = link.favorito ? "favorite-btn favorito" : "favorite-btn";

      html += `
      <div class="link-card" onclick="abrirLink('${link.url}')">
        <img class="favicon-img" data-domain="${dominio}" alt="">
        <div class="link-content">
          <strong>${link.nome}</strong>
          <p>${link.desc || ""}</p>
        </div>
        <span class="${favClass}" onclick="toggleFavorito(event, '${categoria.replace(/'/g,"\\'")}', ${indexOriginal})">‚òÖ</span>
        <span class="link-menu-btn" onclick="abrirMenu(event, '${categoria.replace(/'/g,"\\'")}', ${indexOriginal})">&#8942;</span>
      </div>`;
    });

    html += `</div>`;

    col.innerHTML = html;
    container.appendChild(col);
  });

  if (document.getElementById("searchInput").value.trim() !== "") {
    filtrar();
  }

  carregarFavicons();
  atualizarInfoSincronizacao();
}

// datalist de categorias
function atualizarListaCategorias(){
  const datalist = document.getElementById("catList");
  if (!datalist) return;

  datalist.innerHTML = "";
  const categorias = Object.keys(dados)
    .filter(c => c !== JSON_VERSION_KEY)
    .sort((a,b) => a.localeCompare(b, "pt-BR"));

  categorias.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    datalist.appendChild(opt);
  });
}

// Enter para salvar
function configurarEnter(){
  ["catInput","nameInput","urlInput","descInput"].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("keydown", function(e){
      if(e.key === "Enter"){
        e.preventDefault();
        salvar();
      }
    });
  });
}

// fechar menus ao clicar fora + fechar admin ao clicar fora da caixa
document.addEventListener("click", function(e){
  const contextMenu = document.getElementById("contextMenu");
  const catMenu = document.getElementById("categoryMenu");

  if (contextMenu.style.display === "block" && !e.target.closest("#contextMenu")) {
    contextMenu.style.display = "none";
  }
  if (catMenu.style.display === "block" && !e.target.closest("#categoryMenu")) {
    catMenu.style.display = "none";
  }
});

// fechar painel admin ao clicar no fundo escuro
document.getElementById("adminPanel").addEventListener("click", function(e){
  if (e.target.id === "adminPanel") {
    fecharAdmin();
  }
});

// ===== IMPORT / EXPORT / SYNC / PUSH =====

function exportarJSON(){
  // garante que exista alguma vers√£o
  if (!dadosVersao || Number.isNaN(dadosVersao)) {
    dadosVersao = 1;
    localStorage.setItem("meusLinksVersao", String(dadosVersao));
  }

  const objetoExport = Object.assign(
    {},
    { [JSON_VERSION_KEY]: dadosVersao },
    dados
  );

  const dataStr = JSON.stringify(objetoExport, null, 2);
  const blob = new Blob([dataStr], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "meus_links.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast("Arquivo exportado.");
}

function importarJSON(event){
  const file = event.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(e){
    try {
      const json = JSON.parse(e.target.result);
      if(typeof json === "object" && json !== null){
        const versaoArquivo = Number(json[JSON_VERSION_KEY] || "0");
        if (versaoArquivo) {
          dadosVersao = versaoArquivo;
          localStorage.setItem("meusLinksVersao", String(dadosVersao));
          remoteLastVersao = versaoArquivo;
        }

        // remove chave de vers√£o do objeto de dados
             delete json[JSON_VERSION_KEY];

        dados = json;
        window.dados = dados; // garante que o Firestore veja o novo conte√∫do
        localStorage.setItem("meusLinks", JSON.stringify(dados));
        collapsedCategories = new Set();
        localStorage.removeItem("meusLinksCategoriasFechadas");
        lastCategory = "";
        localStorage.removeItem("meusLinksUltimaCategoria");
        renderizar();
        atualizarListaCategorias();
        showToast("Links importados com sucesso.");

        // dispara salvar na nuvem para sincronizar com outros dispositivos
        if (window.salvarNoFirestore) {
          window.salvarNoFirestore();
        }
    } catch(err){
      alert("Erro ao ler o arquivo. Verifique se √© um JSON v√°lido.");
    }
  };
  reader.readAsText(file);
  event.target.value = "";
}

// bot√£o do painel admin (pull)
function forcarSincronizacao(){
  carregarDeOneDrive(false, true); // manual, s√≥ se vers√£o remota for mais recente
}

// PUSH para GitHub (envia JSON atualizado)
async function enviarParaGit(){
  if (!GITHUB_TOKEN || GITHUB_TOKEN === "COLOQUE_SEU_TOKEN_AQUI") {
    alert("Configure o GITHUB_TOKEN no c√≥digo antes de enviar para o Git.");
    return;
  }

  // 1) Antes de enviar, checa se existe vers√£o remota mais nova (prevenir perda de dados)
  try {
    if (ONEDRIVE_JSON_URL) {
      const urlCheck =
        ONEDRIVE_JSON_URL + (ONEDRIVE_JSON_URL.includes("?") ? "&" : "?") +
        "_t_conflict=" + Date.now();

      const respCheck = await fetch(urlCheck);
      if (respCheck.ok) {
        const jsonRemote = await respCheck.json();
        const versaoRemota = Number(jsonRemote[JSON_VERSION_KEY] || "0");
        if (versaoRemota && versaoRemota > dadosVersao) {
          alert(
            "Existe uma vers√£o mais recente no Git (vers√£o " + versaoRemota +
            ") do que a sua local (vers√£o " + dadosVersao + ").\n\n" +
            "Clique em 'Baixar do Git' primeiro para sincronizar, e depois tente enviar novamente."
          );
          return;
        }
      }
    }
  } catch(e) {
    // se falhar a checagem, segue; se quiser ser mais r√≠gido, pode bloquear aqui
  }

  // 2) incrementa vers√£o para snapshot nova
  if (!dadosVersao || Number.isNaN(dadosVersao)) {
    dadosVersao = 1;
  } else {
    dadosVersao++;
  }
  localStorage.setItem("meusLinksVersao", String(dadosVersao));

  const objetoExport = Object.assign(
    {},
    { [JSON_VERSION_KEY]: dadosVersao },
    dados
  );

  const jsonStr = JSON.stringify(objetoExport, null, 2);
  const conteudoBase64 = btoa(unescape(encodeURIComponent(jsonStr)));

  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`;

  let shaAtual = null;

  try {
    // obt√©m SHA atual (se arquivo j√° existir)
    const respGet = await fetch(url, {
      headers: {
        "Accept": "application/vnd.github+json",
        "Authorization": `Bearer ${GITHUB_TOKEN}`
      }
    });

    if (respGet.status === 200) {
      const json = await respGet.json();
      shaAtual = json.sha;
    } else if (respGet.status !== 404) {
      const text = await respGet.text();
      throw new Error("Erro ao obter SHA: HTTP " + respGet.status + " - " + text);
    }

    // cria/atualiza arquivo
    const respPut = await fetch(url, {
      method: "PUT",
      headers: {
        "Accept": "application/vnd.github+json",
        "Authorization": `Bearer ${GITHUB_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: `Atualiza meus_links via app (${new Date().toISOString()})`,
        content: conteudoBase64,
        sha: shaAtual || undefined
      })
    });

    if (!respPut.ok) {
      const erro = await respPut.text();
      throw new Error("HTTP " + respPut.status + " - " + erro);
    }

    // atualiza info de sync remota
    remoteLastSync = Date.now();
    remoteLastVersao = dadosVersao;
    localStorage.setItem("meusLinksRemoteLastSync", String(remoteLastSync));
    localStorage.setItem("meusLinksRemoteLastVersao", String(remoteLastVersao));

    showToast("JSON enviado para o GitHub com sucesso.");
    atualizarInfoSincronizacao();
  } catch (err) {
    alert("Erro ao enviar para o GitHub: " + err.message);
  }
}

// tenta carregar JSON diretamente do servidor (GitHub raw)
// auto = true ‚Üí chamado na inicializa√ß√£o
// apenasSeMaisRecente = true ‚Üí s√≥ substitui se a vers√£o remota for maior
async function carregarDeOneDrive(auto = false, apenasSeMaisRecente = false){
  if (!ONEDRIVE_JSON_URL) {
    if (!auto) {
      alert("Configure o ONEDRIVE_JSON_URL no c√≥digo com o link p√∫blico do JSON.");
    }
    return;
  }

  // cache inteligente: evita chamadas em sequ√™ncia muito r√°pidas
  if (!auto) {
    const now = Date.now();
    const lastCheck = Number(localStorage.getItem("meusLinksRemoteLastCheck") || "0");
    const intervaloMs = 5000; // 5s
    if (now - lastCheck < intervaloMs) {
      showToast("Voc√™ acabou de sincronizar. Aguarde alguns segundos antes de tentar novamente.");
      return;
    }
    localStorage.setItem("meusLinksRemoteLastCheck", String(now));
  }

  try {
    const urlComCacheBust =
      ONEDRIVE_JSON_URL + (ONEDRIVE_JSON_URL.includes("?") ? "&" : "?") + "_t=" + Date.now();

    const resp = await fetch(urlComCacheBust);

    // tratamento espec√≠fico pra 429
    if (resp.status === 429) {
      if (!auto) {
        alert("O servidor do JSON est√° limitando o n√∫mero de acessos (HTTP 429). Tente novamente mais tarde.");
      }
      return;
    }

    if (!resp.ok) {
      throw new Error("HTTP " + resp.status);
    }

    const json = await resp.json();
    if (typeof json !== "object" || json === null) {
      throw new Error("JSON inv√°lido");
    }

    const versaoRemota = Number(json[JSON_VERSION_KEY] || "0");

    if (apenasSeMaisRecente && versaoRemota && dadosVersao && versaoRemota <= dadosVersao) {
      if (!auto) {
        showToast("JSON remoto n√£o √© mais recente que o local.");
      }
      return;
    }

    if (versaoRemota) {
      dadosVersao = versaoRemota;
      localStorage.setItem("meusLinksVersao", String(dadosVersao));
      remoteLastVersao = versaoRemota;
    }

    delete json[JSON_VERSION_KEY];

    dados = json;
    window.dados = dados;
    localStorage.setItem("meusLinks", JSON.stringify(dados));
    collapsedCategories = new Set();
    localStorage.removeItem("meusLinksCategoriasFechadas");
    lastCategory = "";
    localStorage.removeItem("meusLinksUltimaCategoria");

    // atualiza info de sync remota
    remoteLastSync = Date.now();
    localStorage.setItem("meusLinksRemoteLastSync", String(remoteLastSync));
    localStorage.setItem("meusLinksRemoteLastVersao", String(remoteLastVersao));

    renderizar();
    atualizarListaCategorias();
    showToast("Links carregados do servidor.");
  } catch (err){
    if (!auto) {
      alert("Erro ao carregar do servidor: " + err.message);
    }
  }
}

// inicializa√ß√£o
renderizar();
atualizarListaCategorias();
configurarEnter();
aplicarModoAdmin(); // aplica modo leitura/admin ao abrir
atualizarInfoSincronizacao();
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBgNMLV6ecHc1bqJfGky5dxLUSCkkUxnDg",
    authDomain: "rafa-links.firebaseapp.com",
    projectId: "rafa-links",
    storageBucket: "rafa-links.firebasestorage.app",
    messagingSenderId: "47390718880",
    appId: "1:47390718880:web:269619010ee97045df42c5",
    measurementId: "G-WSD6M2ZJ5E"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const docRef = doc(db, "painelLinks", "principal");

  // üîÑ Garantia extra: se window.dados n√£o existir aqui, cria a partir do localStorage
  if (!window.dados) {
    try {
      window.dados = JSON.parse(localStorage.getItem("meusLinks")) || {};
    } catch {
      window.dados = {};
    }
  }

  async function salvarNoFirestore() {
    console.log("[Firestore] salvarNoFirestore chamado");
    try {
      if (!window.dados || Object.keys(window.dados).length === 0) {
        console.log("[Firestore] sem window.dados, nada para salvar");
        return;
      }
      await setDoc(docRef, window.dados);
      console.log("[Firestore] Dados salvos no Firestore com sucesso");
      if (window.showToast) window.showToast("Salvo na nuvem (Firestore).");
    } catch (e) {
      console.error("[Firestore] Erro ao salvar no Firestore", e);
      if (window.showToast) window.showToast("Erro ao salvar na nuvem.");
    }
  }

  // exp√µe no window pra debug
  window.salvarNoFirestore = salvarNoFirestore;

  async function carregarDoFirestoreInicial() {
    try {
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const dadosRemotos = snap.data();
        console.log("[Firestore] carregando dados iniciais da nuvem", dadosRemotos);
        window.dados = dadosRemotos;
        localStorage.setItem("meusLinks", JSON.stringify(dadosRemotos));
        if (window.renderizar) window.renderizar();
        if (window.atualizarListaCategorias) window.atualizarListaCategorias();
        if (window.showToast) window.showToast("Links carregados da nuvem (Firestore).");
      } else {
        console.log("[Firestore] Documento painelLinks/principal ainda n√£o existe. Ele ser√° criado quando voc√™ salvar.");
      }
    } catch (e) {
      console.error("[Firestore] Erro ao carregar do Firestore", e);
      if (window.showToast) window.showToast("Erro ao carregar da nuvem.");
    }
  }

  // Escuta em tempo real (PC1 ‚Üî PC2)
  onSnapshot(docRef, (snap) => {
    if (!snap.exists()) return;

    const dadosRemotos = snap.data();
    const localStr = JSON.stringify(window.dados || {});
    const remotoStr = JSON.stringify(dadosRemotos);
    if (localStr === remotoStr) return;

    console.log("[Firestore] Atualiza√ß√£o recebida da nuvem", dadosRemotos);
    window.dados = dadosRemotos;
    localStorage.setItem("meusLinks", JSON.stringify(dadosRemotos));
    if (window.renderizar) window.renderizar();
    if (window.atualizarListaCategorias) window.atualizarListaCategorias();
    if (window.showToast) window.showToast("Atualizado pela nuvem (outro dispositivo).");
  });

  // Embrulha as fun√ß√µes que alteram dados
  function wrap(nomeFunc) {
    const original = window[nomeFunc];
    if (typeof original !== "function") return;
    window[nomeFunc] = async function(...args) {
      const resultado = original.apply(this, args);
      try { await salvarNoFirestore(); } catch (e) {}
      return resultado;
    };
  }

  wrap("salvar");
  wrap("apagarLink");
  wrap("excluirCategoria");

  // Carrega da nuvem ao abrir
  carregarDoFirestoreInicial();
</script>


</body>
</html>








